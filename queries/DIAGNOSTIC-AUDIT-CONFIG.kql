// ============================================================================
// DIAGNÃ“STICO: Â¿Por quÃ© no veo logs AUDIT de mi conexiÃ³n?
// ============================================================================

// TEST 1: Ver TODAS las conexiones a "adventureworks" (Ãºltimas 24h)
// ============================================================================
bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(24h)
| where message contains "adventureworks"
| extend 
    UserName = extract(@"user=([^\s,]+)", 1, message),
    DatabaseName = extract(@"database=([^\s,]+)", 1, message),
    ClientHost = extract(@"host=([^\s]+)", 1, message),
    MessageType = case(
        message contains "connection authorized", "ðŸ” CONNECTION",
        message contains "connection received", "ðŸ”Œ CONN_RECEIVED",
        message contains "AUDIT:", "ðŸ“‹ AUDIT",
        message contains "disconnection", "ðŸ‘‹ DISCONNECT",
        message contains "authentication", "ðŸ”‘ AUTH",
        "â“ OTHER"
    )
| project 
    EventProcessedUtcTime,
    MessageType,
    User = UserName,
    Database = DatabaseName,
    Host = ClientHost,
    processId,
    errorLevel,
    message
| order by EventProcessedUtcTime desc;


// ============================================================================
// TEST 2: Comparar configuraciÃ³n AUDIT entre databases
// ============================================================================
// Ver quÃ© databases tienen logs AUDIT activos
bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(24h)
| extend DatabaseName = extract(@"database=([^\s,]+)", 1, message)
| where isnotempty(DatabaseName)
| summarize 
    TotalLogs = count(),
    AuditLogs = countif(message contains "AUDIT:"),
    ConnectionLogs = countif(message contains "connection authorized"),
    HasAudit = iff(countif(message contains "AUDIT:") > 0, "âœ… SÃ", "âŒ NO")
    by DatabaseName
| extend AuditPercentage = round((todouble(AuditLogs) / TotalLogs) * 100, 1)
| project 
    Database = DatabaseName,
    TotalLogs,
    AuditLogs,
    ConnectionLogs,
    AuditPercentage,
    HasAudit
| order by AuditLogs desc;


// ============================================================================
// TEST 3: Ver configuraciÃ³n de pgAudit en el servidor
// ============================================================================
// Buscar logs que mencionen "pgaudit" o "audit" en configuraciÃ³n
bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(7d)
| where message contains "pgaudit" or message contains "shared_preload" or message contains "log_statement"
| project 
    EventProcessedUtcTime,
    LogicalServerName,
    errorLevel,
    message
| order by EventProcessedUtcTime desc
| take 20;


// ============================================================================
// TEST 4: Ver TODOS los logs de TU USUARIO (Ãºltimas 6h)
// ============================================================================
// IMPORTANTE: Reemplaza "TU_USUARIO" con tu nombre de usuario real
let mi_usuario = "TU_USUARIO";  // âš ï¸ CAMBIAR ESTO

bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(6h)
| extend UserName = extract(@"user=([^\s,]+)", 1, message)
| where UserName == mi_usuario or message contains mi_usuario
| extend 
    DatabaseName = extract(@"database=([^\s,]+)", 1, message),
    MessageType = case(
        message contains "connection authorized", "ðŸ” CONNECTION",
        message contains "AUDIT:", "ðŸ“‹ AUDIT",
        message contains "SELECT", "ðŸ” SELECT",
        message contains "INSERT", "âœï¸ INSERT",
        message contains "UPDATE", "ðŸ“ UPDATE",
        message contains "DELETE", "ðŸ—‘ï¸ DELETE",
        "â“ OTHER"
    )
| project 
    EventProcessedUtcTime,
    MessageType,
    User = UserName,
    Database = DatabaseName,
    processId,
    message
| order by EventProcessedUtcTime desc;


// ============================================================================
// TEST 5: Comparar comportamiento entre azure_maintenance y adventureworks
// ============================================================================
bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(1h)
| extend 
    DatabaseName = extract(@"database=([^\s,]+)", 1, message),
    IsAudit = iff(message contains "AUDIT:", 1, 0),
    IsConnection = iff(message contains "connection authorized", 1, 0)
| where DatabaseName in ("azure_maintenance", "adventureworks", "postgres")
| summarize 
    TotalLogs = count(),
    AuditLogs = sum(IsAudit),
    ConnectionLogs = sum(IsConnection),
    SampleMessages = take_any(message, 3)
    by DatabaseName
| extend 
    HasAudit = iff(AuditLogs > 0, "âœ… AuditorÃ­a activa", "âŒ Sin auditorÃ­a"),
    AuditRatio = strcat(AuditLogs, " AUDIT / ", ConnectionLogs, " CONN")
| project 
    Database = DatabaseName,
    TotalLogs,
    AuditRatio,
    HasAudit,
    SampleMessages
| order by AuditLogs desc;


// ============================================================================
// TEST 6: Buscar errores o warnings relacionados con auditorÃ­a
// ============================================================================
bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(24h)
| where errorLevel in ("ERROR", "WARNING", "FATAL")
| where message contains "audit" or message contains "log_statement" or message contains "pgaudit"
| project 
    EventProcessedUtcTime,
    errorLevel,
    LogicalServerName,
    message
| order by EventProcessedUtcTime desc
| take 50;


// ============================================================================
// TEST 7: INVESTIGAR processId ESPECÃFICO (por quÃ© User/Database/Host = UNKNOWN)
// ============================================================================
// IMPORTANTE: Reemplaza con el processId de la anomalÃ­a
let target_processId = 123;  // âš ï¸ CAMBIAR ESTO con el processId de la alerta

// Buscar TODOS los logs de ese processId en las Ãºltimas 48h
bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(48h)
| where processId == target_processId
| extend 
    UserName = extract(@"user=([^\s,]+)", 1, message),
    DatabaseName = extract(@"database=([^\s,]+)", 1, message),
    ClientHost = extract(@"host=([^\s]+)", 1, message),
    MessageType = case(
        message contains "connection authorized", "ðŸ” CONNECTION",
        message contains "connection received", "ðŸ”Œ CONN_RECEIVED",
        message contains "AUDIT:", "ðŸ“‹ AUDIT",
        message contains "disconnection", "ðŸ‘‹ DISCONNECT",
        message contains "authentication", "ðŸ”‘ AUTH",
        "â“ OTHER"
    )
| project 
    EventProcessedUtcTime,
    MessageType,
    User = UserName,
    Database = DatabaseName,
    Host = ClientHost,
    processId,
    backend_type,
    LogicalServerName,
    message
| order by EventProcessedUtcTime asc;  // Orden ascendente para ver la historia de la sesiÃ³n


// ============================================================================
// TEST 8: Verificar cobertura de sessionInfo (Ãºltimas 24h)
// ============================================================================
// Ver cuÃ¡ntos processId tienen informaciÃ³n de User/Database/Host disponible
let sessionInfo = 
bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(24h)
| where message contains "connection authorized" or message contains "connection received"
| extend 
    UserName = extract(@"user=([^\s,]+)", 1, message),
    DatabaseName = extract(@"database=([^\s,]+)", 1, message),
    ClientHost = extract(@"host=([^\s]+)", 1, message)
| where isnotempty(UserName)
| summarize User = any(UserName), Database = any(DatabaseName), SourceHost = any(ClientHost)
    by processId, LogicalServerName;

bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(1h)
| where message contains "AUDIT:"
| summarize AuditCount = count() by processId, LogicalServerName
| join kind=leftouter sessionInfo on processId, LogicalServerName
| extend HasUserInfo = iff(isempty(User), "âŒ UNKNOWN", "âœ… KNOWN")
| summarize 
    TotalProcesses = dcount(processId),
    ProcessesWithUserInfo = dcountif(processId, HasUserInfo == "âœ… KNOWN"),
    ProcessesWithoutUserInfo = dcountif(processId, HasUserInfo == "âŒ UNKNOWN"),
    TotalAuditLogs = sum(AuditCount)
| extend CoveragePercentage = round((todouble(ProcessesWithUserInfo) / TotalProcesses) * 100, 1)
| project 
    TotalAuditProcesses = TotalProcesses,
    WithUserInfo = ProcessesWithUserInfo,
    WithoutUserInfo = ProcessesWithoutUserInfo,
    CoveragePercentage = strcat(CoveragePercentage, "%"),
    TotalAuditLogs;


// ============================================================================
// TEST 9: Ver AUDIT logs SIN informaciÃ³n de usuario (Ãºltimos 15 minutos)
// ============================================================================
// Identificar quÃ© processId generan AUDIT sin conexiÃ³n conocida
let sessionInfo = 
bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(24h)
| where message contains "connection authorized" or message contains "connection received"
| extend 
    UserName = extract(@"user=([^\s,]+)", 1, message),
    DatabaseName = extract(@"database=([^\s,]+)", 1, message)
| where isnotempty(UserName)
| summarize User = any(UserName), Database = any(DatabaseName)
    by processId, LogicalServerName;

bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(15m)
| where message contains "AUDIT:"
| join kind=leftanti sessionInfo on processId, LogicalServerName  // Solo los que NO tienen sessionInfo
| extend 
    AuditOperation = extract(@"AUDIT: SESSION,\d+,\d+,[A-Z]+,([A-Z ]+),", 1, message),
    TableName = extract(@"AUDIT: SESSION,\d+,\d+,[A-Z]+,[A-Z ]+,([^,]*),", 1, message)
| summarize 
    AuditCount = count(),
    Operations = make_set(AuditOperation, 5),
    Tables = make_set(TableName, 5),
    FirstSeen = min(EventProcessedUtcTime),
    LastSeen = max(EventProcessedUtcTime),
    SampleMessage = take_any(message)
    by processId, LogicalServerName, backend_type
| extend 
    Category = case(
        backend_type == "client backend", "ðŸ‘¤ USUARIO REAL",
        backend_type == "pg_qs_background_worker", "ðŸ¤– Query Store Worker",
        backend_type == "pg-availability", "ðŸ’š Health Check",
        backend_type == "pgms_stats_background_worker", "ðŸ“Š Stats Worker",
        backend_type == "autovacuum worker", "ðŸ§¹ Autovacuum",
        backend_type == "logical replication launcher", "ðŸ”„ Replication",
        "â“ Otro Worker"
    ),
    Priority = case(
        backend_type == "client backend", 1,  // Alta prioridad - investigar
        2  // Baja prioridad - workers internos esperados
    )
| order by Priority asc, AuditCount desc
| project 
    Category,
    ProcessID = processId,
    Server = LogicalServerName,
    BackendType = backend_type,
    AuditCount,
    Operations = strcat_array(Operations, ", "),
    Tables = strcat_array(Tables, ", "),
    FirstSeen,
    LastSeen,
    SampleMessage;


// ============================================================================
// TEST 10: Cobertura de pgaudit por DATABASE (Ãºltimas 24h)
// ============================================================================
// Verifica quÃ© databases tienen pgaudit extension instalada y funcionando
bronze_pssql_alllogs_nometrics
| where EventProcessedUtcTime >= ago(24h)
| extend DatabaseName = extract(@"database=([^\s,]+)", 1, message)
| where isnotempty(DatabaseName)
| summarize 
    TotalLogs = count(),
    AuditLogs = countif(message contains "AUDIT:"),
    ConnectionLogs = countif(message contains "connection authorized"),
    ErrorLogs = countif(errorLevel in ("ERROR", "WARNING", "FATAL")),
    AuditOperations = make_set(extract(@"AUDIT: SESSION,\d+,\d+,([A-Z]+),", 1, message), 10)
    by DatabaseName
| extend 
    AuditPercentage = round((todouble(AuditLogs) / TotalLogs) * 100, 2),
    AuditStatus = case(
        AuditLogs > 100, "âœ… AUDIT ACTIVO",
        AuditLogs > 0, "âš ï¸ AUDIT BAJO",
        "âŒ SIN AUDIT"
    ),
    EstimatedCoverage = case(
        AuditPercentage > 5.0, "ðŸŸ¢ Alta",
        AuditPercentage > 1.0, "ðŸŸ¡ Media",
        AuditPercentage > 0, "ðŸŸ  Baja",
        "ðŸ”´ Ninguna"
    ),
    RecommendedAction = case(
        AuditLogs == 0, "Ejecutar: CREATE EXTENSION pgaudit;",
        AuditPercentage < 1.0, "Verificar pgaudit.log = 'ALL'",
        "ConfiguraciÃ³n OK"
    )
| project 
    Database = DatabaseName,
    AuditStatus,
    Coverage = EstimatedCoverage,
    AuditLogs,
    ConnectionLogs,
    ErrorLogs,
    AuditPercentage = strcat(AuditPercentage, "%"),
    Operations = strcat_array(AuditOperations, ", "),
    RecommendedAction
| order by AuditLogs desc;

